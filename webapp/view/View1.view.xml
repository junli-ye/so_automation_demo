<!--
/******************************************************************
 * SO Automation Application - Main View
 * 
 * This view implements a three-section interface for SO processing:
 * 1. File Upload: Handles Excel file selection and validation
 * 2. Process Configuration: Manages customer selection, rules, and batch size
 * 3. Results Display: Shows processing results in a sortable/filterable table
 * 
 * Author: Junli Ye
 * Version: 1.0.0
 * Last Updated: August 12, 2025
 ******************************************************************/
-->
<mvc:View
    controllerName="yegeoaiso.controller.View1"
    xmlns:mvc="sap.ui.core.mvc"
    xmlns="sap.m"
    xmlns:u="sap.ui.unified"
    xmlns:l="sap.ui.layout"
    xmlns:core="sap.ui.core"
    xmlns:m="sap.m">

    <Page
        id="page"
        title="SO Automation Demo"
        backgroundDesign="Transparent">

        <content>
            <!--
            /************************
             * File Upload Section
             * 
             * Components:
             * - FileUploader: Accepts only .xlsx files
             * - MessageStrip: Shows selected file name and status
             ************************/
            -->
            <Panel
                expandable="true"
                expanded="true"
                headerText="Upload Excel File"
                width="auto"
                class="sapUiNoContentPadding">
                <headerToolbar>
                    <Toolbar style="Clear">
                        <Title text="Upload Excel File"/>
                        <ToolbarSpacer/>
                        <core:Icon src="sap-icon://upload" class="sapUiTinyMarginEnd"/>
                    </Toolbar>
                </headerToolbar>
                <content>
                    <HBox alignItems="Center" class="sapUiSmallMargin">
                        <!-- <u:FileUploader
                            id="fileUploader"
                            buttonText="Choose Excel File"
                            accept=".xlsx"
                            change="onFileSelect"
                            style="Emphasized"/> -->
                        <u:FileUploader
                            id="fileUploader"
                            buttonText="Choose Excel File"
                            fileType="xlsx"
                            change="onFileSelect"
                            style="Emphasized"
                            useMultipart="false"
                            sendXHR="true"/>
                        <Button
                            id="extractButton"
                            text="Extract Excel File"
                            press="onExtractPress"
                            type="Emphasized"
                            icon="sap-icon://excel-attachment"
                            class="sapUiTinyMarginBegin"
                            tooltip="Extract data from the selected Excel file"/>
                        <MessageStrip
                            id="fileNameStrip"
                            text="No file selected"
                            type="Information"
                            showIcon="true"
                            class="sapUiTinyMarginBegin"/>
                    </HBox>
                </content>
            </Panel>

            <!--
            /*************************************
             * Process Configuration Section
             * 
             * Left Side:
             * - Customer Selection Dropdown
             * - Batch Size Selection (1/5/10)
             * - Start Processing Button
             * 
             * Right Side:
             * - Rule Configuration Preview/Editor
             * - Edit/Cancel Buttons
             *************************************/
            -->
            <Panel
                expandable="true"
                expanded="true"
                headerText="Process Configuration"
                width="auto"
                class="sapUiNoContentPadding">
                <headerToolbar>
                    <Toolbar style="Clear">
                        <Title text="Process Configuration"/>
                        <ToolbarSpacer/>
                        <core:Icon src="sap-icon://settings" class="sapUiTinyMarginEnd"/>
                    </Toolbar>
                </headerToolbar>
                <content>
                    <HBox class="sapUiSmallMargin" renderType="Bare">
                        <!-- Left Section: Customer and Batch Size -->
                        <VBox width="300px" class="sapUiTinyMarginEnd">
                            <!-- Customer Selection -->
                            <Label text="Customer" required="true" class="sapUiTinyMarginBottom"/>
                            <!-- <Select
                                id="customerSelect"
                                change="onCustomerChange"
                                class="sapUiSmallMarginBottom"
                                width="100%">
                                <core:Item key="customerA" text="Customer A"/>
                                <core:Item key="customerB" text="Customer B"/>
                            </Select> -->
                            <Select
                                id="customerSelect"
                                change="onCustomerChange"
                                class="sapUiSmallMarginBottom"
                                width="100%"
                                items="{customerRules>/customers}">
                                <core:Item key="{customerRules>key}" text="{customerRules>name}"/>
                            </Select>
                            <!-- Batch Size Selection -->
                            <Label text="Batch Size" required="true" class="sapUiTinyMarginBottom"/>
                            <Select
                                id="batchSizeSelect"
                                class="sapUiSmallMarginBottom"
                                width="100%">
                                <core:Item key="1" text="1 record per batch"/>
                                <core:Item key="5" text="5 records per batch"/>
                                <core:Item key="10" text="10 records per batch"/>
                            </Select>
                            <!-- Action Button -->
                            <Button
                                id="btnAutomation"
                                text="Start AI Automation"
                                type="Emphasized"
                                width="100%"
                                icon="sap-icon://activate"
                                press="onStartAutomation"/>
                        </VBox>
                        <!-- Right Section: Rule Preview -->
                        <VBox width="100%" class="sapUiTinyMarginBegin">
                            <HBox justifyContent="SpaceBetween" class="sapUiTinyMarginBottom">
                                <Label text="Rule Configuration" required="true"/>
                                <HBox>
                                    <Button
                                        id="btnEditRule"
                                        text="Edit Rule"
                                        icon="sap-icon://edit"
                                        press="onEditRule"
                                        class="sapUiTinyMarginEnd"/>
                                    <Button
                                        id="btnCancelEditRule"
                                        text="Cancel"
                                        icon="sap-icon://cancel"
                                        visible="false"
                                        press="onCancelEditRule"/>
                                </HBox>
                            </HBox>
                            <TextArea
                                id="rulePreview"
                                rows="8"
                                width="100%"
                                editable="false"/>
                        </VBox>
                    </HBox>
                </content>
            </Panel>

            <!--
            /*********************************
             * Results Section
             * 
             * Features:
             * - Expandable panel with search
             * - Status column with icons
             * - Row index for reference
             * - PO Number identification
             * - Detailed result message
             * 
             * Data Binding:
             * - Bound to results>/rows model
             * - Supports sorting and filtering
             *********************************/
            -->
            <Panel
                expandable="true"
                expanded="true"
                headerText="Processing Results"
                width="auto"
                class="sapUiNoContentPadding">
                <headerToolbar>
                    <Toolbar style="Clear">
                        <Title text="Processing Results"/>
                        <!-- 添加进度条和处理状态 -->
                        <ToolbarSpacer width="2rem"/>
                        <ProgressIndicator
                            id="processingProgress"
                            width="200px"
                            percentValue="{batch>/progress}"
                            displayValue="{batch>/progress}%"
                            showValue="true"
                            state="{= ${batch>/progress} === 100 ? 'Success' : 'Information'}"
                            class="sapUiTinyMarginEnd"/>
                        <Text text="{batch>/processedCount} of {batch>/totalCount} Processed" class="sapUiTinyMarginEnd"/>
                        <ToolbarSpacer/>
                        <SearchField 
                            id="resultsSearchField"
                            width="15rem" 
                            placeholder="Search results..." 
                            search="onResultsSearch"/>
                        <Button
                            icon="sap-icon://action-settings"
                            tooltip="Table Settings"
                            press="onTableSettingsPress"/>
                        <core:Icon src="sap-icon://table-view" class="sapUiTinyMarginEnd"/>
                    </Toolbar>
                </headerToolbar>
                <content>
                    <VBox class="sapUiSmallMargin">
                        <Table
                            id="resultsTable"
                            items="{
                                path: 'results>/rows',
                                sorter: {
                                    path: 'rowIndex',
                                    descending: false
                                }
                            }"
                            sticky="ColumnHeaders"
                            growing="true"
                            growingThreshold="1000"
                            growingScrollToLoad="true">
                            <columns>
                                <!-- 固定列 -->
                                <Column width="80px" hAlign="Begin"><Text text="Row #" /></Column>
                                <Column width="100px" hAlign="Begin"><Text text="Status" /></Column>
                                <Column hAlign="Begin">
                                    <Text text="Message" />
                                </Column>
                                <!-- 根据客户显示动态列 -->
                                <Column visible="{= ${customerRules>/selectedCustomer} === 'C001' || ${customerRules>/selectedCustomer} === 'C002'}" hAlign="Begin">
                                    <Text text="Customer Code" />
                                </Column>
                                <Column visible="{= ${customerRules>/selectedCustomer} === 'C001' || ${customerRules>/selectedCustomer} === 'C002'}" hAlign="Begin">
                                    <Text text="PO Number" />
                                </Column>
                                <Column visible="{= ${customerRules>/selectedCustomer} === 'C001' || ${customerRules>/selectedCustomer} === 'C002'}" hAlign="Begin">
                                    <Text text="PO Date" />
                                </Column>
                                <Column visible="{= ${customerRules>/selectedCustomer} === 'C001' || ${customerRules>/selectedCustomer} === 'C002'}" hAlign="Begin">
                                    <Text text="Item No" />
                                </Column>
                                <!-- 客户 A 特有列 -->
                                <Column visible="{= ${customerRules>/selectedCustomer} === 'C001'}" hAlign="Begin">
                                    <Text text="PO Line" />
                                </Column>
                                <Column hAlign="Begin">
                                    <Text text="Customer Part No" />
                                </Column>
                                <Column hAlign="Begin">
                                    <Text text="Quantity" />
                                </Column>
                                <Column hAlign="Begin">
                                    <Text text="Request Date" />
                                </Column>
                                <!-- 客户 A 特有列 -->
                                <Column visible="{= ${customerRules>/selectedCustomer} === 'C001'}" hAlign="Begin">
                                    <Text text="Net Price" />
                                </Column>
                                <Column hAlign="Begin">
                                    <Text text="Part No" />
                                </Column>
                                <Column hAlign="Begin">
                                    <Text text="Sales Order Type" />
                                </Column>
                                <!-- 客户 B 特有列 -->
                                <Column visible="{= ${customerRules>/selectedCustomer} === 'C002'}" hAlign="Begin">
                                    <Text text="Plant" />
                                </Column>
                                <Column visible="{= ${customerRules>/selectedCustomer} === 'C002'}" hAlign="Begin">
                                    <Text text="Ship To" />
                                </Column>
                                <Column hAlign="Begin">
                                    <Text text="Reason" />
                                </Column>
                            </columns>
                            <items>
                                <ColumnListItem>
                                    <cells>
                                        <Text text="{results>rowIndex}" />
                                        <!-- 修改：无论valid是true还是false都显示绿色对勾 -->
                                        <ObjectStatus
                                            text="{= ${results>valid} ? 'Valid' : 'Invalid' }"
                                            state="Success"
                                            icon="sap-icon://status-positive"/>
                                        <Text text="{results>result}" />
                                        <Text text="{results>customerCode}" />
                                        <Text text="{results>poNumber}" />
                                        <Text text="{results>poDate}" />
                                        <Text text="{results>itemNo}" />
                                        <Text text="{results>poLine}" />
                                        <Text text="{results>customerPartNo}" />
                                        <Text text="{results>quantity}" />
                                        <Text text="{results>requestDate}" />
                                        <Text text="{results>netPrice}" />
                                        <Text text="{results>partNo}" />
                                        <Text text="{results>salesOrderType}" />
                                        <Text text="{results>plant}" />
                                        <Text text="{results>shipTo}" />
                                        <Text text="{= ${results>valid} ? '' : ${results>reason}}" />
                                    </cells>
                                </ColumnListItem>
                            </items>
                        </Table>
                    </VBox>
                </content>
            </Panel>
        </content>
    </Page>
</mvc:View>
